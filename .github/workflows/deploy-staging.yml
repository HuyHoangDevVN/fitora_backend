name: Deploy Microservices to Staging

on:
  push:
    branches:
      - staging

jobs:
  build-and-deploy:
    runs-on: [self-hosted, windows]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      # ===== gRPC Services (Kestrel standalone) =====
      - name: Build & Publish UserService (gRPC)
        run: |
          dotnet restore
          dotnet build --configuration Release --no-restore
          dotnet publish --configuration Release --output C:\deploy\userservice --no-restore --no-build
        working-directory: ./Services/UserService/UserService.API
        shell: powershell

      - name: Build & Publish InteractService (gRPC)
        run: |
          dotnet restore
          dotnet build --configuration Release --no-restore
          dotnet publish --configuration Release --output C:\deploy\interactservice --no-restore --no-build
        working-directory: ./Services/InteractService/InteractService.API
        shell: powershell

      - name: Restart gRPC Windows Services (User/Interact)
        run: |
          function Restart-ServiceSafe($name) {
              $svc = Get-Service $name -ErrorAction SilentlyContinue
              if ($svc -and $svc.Status -eq 'Running') {
                  sc.exe stop $name
                  $timeout = 30
                  while ((Get-Service $name).Status -ne 'Stopped' -and $timeout -gt 0) {
                      Start-Sleep -Seconds 1
                      $timeout--
                  }
              }
              sc.exe start $name
              $timeout = 30
              while ((Get-Service $name).Status -ne 'Running' -and $timeout -gt 0) {
                  Start-Sleep -Seconds 1
                  $timeout--
              }
          }

          Restart-ServiceSafe userservice
          Restart-ServiceSafe interactservice
        shell: powershell

      # ===== Web API Services (IIS) =====
      - name: Build & Publish AuthService (IIS)
        run: |
          dotnet restore
          dotnet build --configuration Release --no-restore
          dotnet publish --configuration Release --output C:\publish\authservice --no-restore --no-build
        working-directory: ./Services/AuthService/AuthService.API
        shell: powershell

      - name: Build & Publish ChatService (IIS)
        run: |
          dotnet restore
          dotnet build --configuration Release --no-restore
          dotnet publish --configuration Release --output C:\publish\chatservice --no-restore --no-build
        working-directory: ./Services/ChatService/ChatService.API
        shell: powershell

      - name: Build & Publish ApiGateway (IIS)
        run: |
          dotnet restore
          dotnet build --configuration Release --no-restore
          dotnet publish --configuration Release --output C:\publish\apigateway --no-restore --no-build
        working-directory: ./ApiGateways/ApiGateway
        shell: powershell

      - name: Deploy Web APIs to IIS
        run: |
          $services = @("authservice", "chatservice", "apigateway")

          net stop w3svc

          foreach ($service in $services) {
            $target = "C:\inetpub\wwwroot\$service"
            Remove-Item "$target\*" -Recurse -Force -ErrorAction SilentlyContinue
            Copy-Item "C:\publish\$service\*" -Destination $target -Recurse
          }

          net start w3svc
        shell: powershell
